<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Assistance System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-title glow">Real Time Attention Monitoring System</div>
    <div class="container">
        <div class="left-panel">
            <h2 class="panel-title glow">Live Webcam Feed</h2>
            <div class="video-container">
                <img id="video-stream" src="{{ url_for('video_feed') }}" width="100%">
                <div id="camera-status" class="camera-disconnected">
                    <span></span> Camera Disconnected
                </div>
            </div>
            <div class="timestamp-bar">
                <span id="current-datetime">Loading date and time...</span>
            </div>
        </div>

        <div class="right-panel">
            <div class="header">
                <h2 class="panel-title">System Status</h2>
                <div class="controls">
                    <button id="start-btn" class="control-btn">Start</button>
                    <button id="stop-btn" class="control-btn">Stop</button>
                </div>
            </div>

            <div class="status-grid">
                <div class="status-box">
                    <h3>Attention</h3>
                    <div id="attention-score" class="status-value large">--%</div>
                </div>
                <div class="status-box">
                    <h3>Alertness</h3>
                    <div id="alertness-level" class="status-value large">--</div>
                </div>
            </div>

            <div class="alert-section">
                <div id="current-alert-box" class="alert-box alert-none">
                    <div class="alert-header">
                        <span class="icon">&#10004;</span>
                        <span id="current-alert-title">No Active Alert</span>
                    </div>
                    <p id="current-alert-details">System monitoring normally</p>
                    <button id="dismiss-alert-btn" class="dismiss-btn">âœ” Dismiss Alert</button>
                </div>
            </div>
            
            <div class="log-section">
                <h3>Alert History Log</h3>
                <div class="log-header">
                    <button id="clear-log-btn" class="log-btn">Clear Log</button>
                    <span id="log-total">Total: 0 alerts</span>
                </div>
                <ul id="alert-history-list" class="alert-log">
                    </ul>
            </div>
        </div>
    </div>
    <footer class="footer">
        &copy; JVM, Christ University, Bangalore 2025
    </footer>

    <script>
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            document.getElementById('current-datetime').textContent = now.toLocaleString('en-US', options);
        }

        async function dismissAlert() {
            // This function is kept for future use if a dismiss endpoint is added.
            // For now, alerts are managed by the backend state.
            console.log("Dismiss button clicked.");
        }

        async function clearLog() {
            try {
                await fetch('/clear_log', { method: 'POST' });
                updateStatus(); // Refresh the UI to show the cleared log
            } catch (error) {
                console.error('Failed to clear log:', error);
            }
        }

        async function startCV() {
            try {
                document.getElementById('video-stream').style.display = 'block';
                await fetch('/start_cv', { method: 'POST' });
                console.log("Attempted to start CV thread.");
            } catch (error) {
                console.error('Failed to send start command:', error);
            }
        }

        async function stopCV() {
            try {
                await fetch('/stop_cv', { method: 'POST' });
                document.getElementById('video-stream').style.display = 'none';
                console.log("Attempted to stop CV thread.");
            } catch (error) {
                console.error('Failed to send stop command:', error);
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/status');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                // 1. Update Attention and Alertness
                document.getElementById('attention-score').textContent = `${data.attention_score}%`;
                const alertnessEl = document.getElementById('alertness-level');
                alertnessEl.textContent = data.alertness;
                alertnessEl.className = 'status-value large';
                if (data.alertness === 'Low') {
                    alertnessEl.classList.add('low');
                } else if (data.alertness === 'Medium') {
                    alertnessEl.classList.add('medium');
                } else if (data.alertness === 'N/A') {
                    alertnessEl.classList.add('medium'); // Or a neutral color
                }

                // 2. Update Current Alert Box
                const alertBox = document.getElementById('current-alert-box');
                const alertTitle = document.getElementById('current-alert-title');
                const alertDetails = document.getElementById('current-alert-details');
                const alertIcon = alertBox.querySelector('.icon');
                const dismissBtn = document.getElementById('dismiss-alert-btn');

                alertBox.className = 'alert-box';
                if (data.current_alert === 'No Active Alert') {
                    alertBox.classList.add('alert-none');
                    alertTitle.textContent = 'No Active Alert';
                    alertDetails.textContent = 'System monitoring normally';
                    alertIcon.innerHTML = '&#10004;';
                    dismissBtn.style.display = 'none';
                } else {
                    alertTitle.textContent = data.current_alert;
                    alertDetails.textContent = `Severity: ${data.alert_severity} | Detected at: ${data.alert_timestamp}`;
                    alertIcon.innerHTML = '&#9888;';
                    dismissBtn.style.display = 'block';
                    if (data.alert_severity === 'HIGH') {
                        alertBox.classList.add('alert-high');
                    } else if (data.alert_severity === 'MEDIUM') {
                         alertBox.classList.add('alert-medium');
                    } else {
                        alertBox.classList.add('alert-low');
                    }
                }
                
                // 3. Update Alert History
                const historyList = document.getElementById('alert-history-list');
                historyList.innerHTML = '';
                if (data.alert_history.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'log-item-empty';
                    li.textContent = 'Log is empty.';
                    historyList.appendChild(li);
                } else {
                    data.alert_history.forEach(item => {
                        const li = document.createElement('li');
                        li.className = `log-item log-${item.severity.toLowerCase()}`;
                        li.innerHTML = `
                            <strong>${item.alert}</strong>
                            <span>Severity: ${item.severity} | ${item.time}</span>
                        `;
                        historyList.appendChild(li);
                    });
                }
                document.getElementById('log-total').textContent = `Total: ${data.alert_history.length} alerts`;

                // 4. Update Camera Status
                const cameraStatusEl = document.getElementById('camera-status');
                if (data.camera_connected) {
                    cameraStatusEl.className = 'camera-connected';
                    cameraStatusEl.innerHTML = '<span></span> Camera Connected';
                } else {
                    cameraStatusEl.className = 'camera-disconnected';
                    cameraStatusEl.innerHTML = '<span></span> Camera Disconnected';
                    document.getElementById('video-stream').style.display = 'none';
                }

            } catch (error) {
                console.error('Failed to fetch status:', error);
                const cameraStatusEl = document.getElementById('camera-status');
                cameraStatusEl.className = 'camera-disconnected';
                cameraStatusEl.innerHTML = '<span></span> Server Connection Lost';
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            updateDateTime();
            setInterval(updateDateTime, 1000);

            updateStatus();
            setInterval(updateStatus, 500); // Fetch status frequently

            // --- Control Button Event Listeners ---
            document.getElementById('start-btn').addEventListener('click', startCV);
            document.getElementById('stop-btn').addEventListener('click', stopCV);
            document.getElementById('clear-log-btn').addEventListener('click', clearLog);
            document.getElementById('dismiss-alert-btn').addEventListener('click', dismissAlert);
        });
    </script>
</body>
</html>